name: Sync Portsmouth Calendar

on:
  schedule:
    # Run daily at 6 AM EST (11 AM UTC)
    - cron: '0 11 * * *'
  workflow_dispatch: # Allow manual trigger

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install

      - name: Create config directory
        run: mkdir -p config

      - name: Write Google credentials
        run: echo '${{ secrets.GOOGLE_CREDENTIALS }}' | base64 -d > config/credentials.json

      - name: Write OAuth token
        run: echo '${{ secrets.GOOGLE_TOKEN }}' | base64 -d > config/token.json

      - name: Run sync
        env:
          GOOGLE_CALENDAR_ID: ${{ secrets.GOOGLE_CALENDAR_ID }}
        run: npm run sync 2>&1 | tee sync.log

      - name: Upload sync log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: sync-log-${{ github.run_number }}
          path: sync.log
          retention-days: 7

      - name: Generate summary
        if: always()
        run: |
          echo "### Portsmouth Calendar Sync Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Run Number:** ${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "**Date:** $(date)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### Log Output:" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          tail -50 sync.log >> $GITHUB_STEP_SUMMARY || echo "No log available" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
